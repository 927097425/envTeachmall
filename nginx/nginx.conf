
#user  nobody;
worker_processes  1;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

#pid        logs/nginx.pid;


events {
    worker_connections  1024;
}


http {
        log_format debug_format '$remote_addr - $remote_user [$time_local] "$request" '
                                'status=$status upstream_addr=$upstream_addr '
                                'upstream_response_time=$upstream_response_time '
                                'request_time=$request_time';

        access_log /var/log/nginx/debug_access.log debug_format;

    map $http_host $host_server {
        default 8.138.159.37;
    }
    map $http_host $gateway_server {
        default 2b9d2256.r16.cpolar.top;
    }
    include       mime.types;
    default_type  application/octet-stream;
    client_max_body_size 500M; # 设置客户端请求体最大值
    client_body_buffer_size 1024k; # 设置请求体缓存区大小
    #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
    #                  '$status $body_bytes_sent "$http_referer" '
    #                  '"$http_user_agent" "$http_x_forwarded_for"';

    #access_log  logs/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    send_timeout 600; # 设置响应超时时间为10分钟
    keepalive_timeout  600;

    #gzip  on;
   #文件服务
  upstream fileserver{
    server minio:9000 weight=10;
  } 
     #后台网关,上线后暴露为网关内网穿透的地址
  upstream gatewayserver{
    server 2b9d2256.r16.cpolar.top max_fails=30 fail_timeout=600s;
  } 


server {
        listen       80;
        server_name $host_server;
        #rewrite ^(.*) https://$server_name$1 permanent;
        #charset koi8-r;
        ssi on;
        ssi_silent_errors on;
        #access_log  logs/host.access.log  main;


        location / {
            alias  /usr/share/nginx/html/;
            index  index.html index.htm;
            sub_filter 'www.51xuecheng.cn' $host_server;
            sub_filter_once off; # 替换所有匹配项
            proxy_pass_header Set-Cookie;
        }
        location /static/img/ {  
                alias  /usr/share/nginx/html/img/;
                sub_filter 'www.51xuecheng.cn' $host_server;
                sub_filter_once off; # 替换所有匹配项
                proxy_pass_header Set-Cookie;
        } 
        location /static/css/ {  
                alias   /usr/share/nginx/html/css/;
                sub_filter 'www.51xuecheng.cn' $host_server;
                sub_filter_once off; # 替换所有匹配项
                proxy_pass_header Set-Cookie;
        } 
        location /static/js/ {  
                alias   /usr/share/nginx/html/js/;
                sub_filter 'www.51xuecheng.cn' $host_server;
                sub_filter_once off; # 替换所有匹配项
                proxy_pass_header Set-Cookie;
        } 
        location /static/plugins/ {  
                alias   /usr/share/nginx/html/plugins/;
                add_header Access-Control-Allow-Origin http://ucenter.51xuecheng.cn;  
                add_header Access-Control-Allow-Credentials true;  
                add_header Access-Control-Allow-Methods GET;
                sub_filter 'www.51xuecheng.cn' $host_server;
                sub_filter_once off; # 替换所有匹配项
                proxy_pass_header Set-Cookie;
        } 
        location /plugins/ {  
                alias   /usr/share/nginx/html/plugins/;
                sub_filter 'www.51xuecheng.cn' $host_server;
                sub_filter_once off; # 替换所有匹配项
                proxy_pass_header Set-Cookie;
        } 
        location /course/preview/learning.html {
                alias /usr/share/nginx/html/course/learning.html;
                sub_filter 'www.51xuecheng.cn' $host_server;
                sub_filter_once off; # 替换所有匹配项
                proxy_pass_header Set-Cookie;
        } 
        location /course/search.html {  
                root   /usr/share/nginx/html;
                sub_filter 'www.51xuecheng.cn' $host_server;
                sub_filter_once off; # 替换所有匹配项
                proxy_pass_header Set-Cookie;
        } 
        location /course/learning.html {  
                root   /usr/share/nginx/html;
                sub_filter 'www.51xuecheng.cn' $host_server;
                sub_filter_once off; # 替换所有匹配项
                proxy_pass_header Set-Cookie;
        } 
        location /ucenter/index.html {  
                root   /usr/share/nginx/html;
                sub_filter 'www.51xuecheng.cn' $host_server;
                sub_filter_once off; # 替换所有匹配项
                proxy_pass_header Set-Cookie;
        } 


        location /api/ {
                proxy_pass http://gatewayserver/;
                # proxy_pass http://2b9d2256.r16.cpolar.top/;
                proxy_set_header Host $gateway_server;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                sub_filter 'www.51xuecheng.cn' $host_server;
                sub_filter_once off; # 替换所有匹配项
                proxy_set_header Authorization $http_authorization;
                
                
                
        }
        
	
        location ~ ^/course/([0-9]+)\.html$ {
                proxy_pass  http://gatewayserver/content/coursepreview/$1;
                proxy_set_header Host $gateway_server;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                sub_filter 'www.51xuecheng.cn' $host_server;
                sub_filter_once off; # 替换所有匹配项
                proxy_pass_header Set-Cookie;
        }


        #openapi
        location /open/content/ {
                proxy_pass http://gatewayserver/content/open/;
                proxy_set_header Host $gateway_server;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                sub_filter 'www.51xuecheng.cn' $host_server;
                sub_filter_once off; # 替换所有匹配项
                proxy_pass_header Set-Cookie;
        } 
        location /open/media/ {
                proxy_pass http://gatewayserver/media/open/;
                proxy_set_header Host $gateway_server;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                sub_filter 'www.51xuecheng.cn' $host_server;
                sub_filter_once off; # 替换所有匹配项
                proxy_pass_header Set-Cookie;
        } 


        location /video {
                proxy_pass   http://fileserver;
                sub_filter 'www.51xuecheng.cn' $host_server;
                sub_filter_once off; # 替换所有匹配项
                proxy_pass_header Set-Cookie;
        }

        location /mediafiles {
                proxy_pass   http://fileserver;
                sub_filter 'www.51xuecheng.cn' $host_server;
                sub_filter_once off; # 替换所有匹配项
                proxy_pass_header Set-Cookie;
        }

        location /teacher/index.html {
                alias /usr/share/nginx/html/teacher/index.html;
                sub_filter 'www.51xuecheng.cn' $host_server;
                sub_filter_once off; # 替换所有匹配项
                proxy_pass_header Set-Cookie;
                
        }
        #error_page  404              /404.html;

        # redirect server error pages to the static page /50x.html
        #
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
}

        server {
                listen 8160;
                server_name 8.138.159.37;

                location /api {
                        proxy_pass http://gatewayserver;
                        #proxy_pass http://8.138.159.37:63010;
                        proxy_set_header Host $gateway_server;
                        proxy_set_header X-Real-IP $remote_addr;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                        proxy_set_header X-Forwarded-Proto $scheme;
                        sub_filter 'www.51xuecheng.cn' $host_server;
                        sub_filter_once off; # 替换所有匹配项
                        proxy_pass_header Set-Cookie;
                        # # 这里需要添加一个rewrite规则，把请求中的/api去掉
                        # rewrite ^/api(.*)$ $1 break;

                }
        }





}


    
